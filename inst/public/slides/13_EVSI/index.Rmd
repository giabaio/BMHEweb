---
title: "&#8291;13. Expected value of sample information"
author: Gianluca Baio
institute: "[Department of Statistical Science](https://www.ucl.ac.uk/statistics/) | University College London"
params: 
   - conference: "Bayesian Methods in Health Economics"
   - location: "Lausanne"
date: 
output:
  xaringan::moon_reader:
    includes: 
       in_header: "../assets/latex_macros.html" 
       ## This line adds a logo based on the format selected in the file 'assets/THEME/include_logo.html'
       ## NB: the actual options (eg placement of the logo and actual logo file) can be changed there
       ## There's also a script to manipulate the colouring scheme for the UCL logo (from a basic black/white one)
       after_body: "../assets/beamer/insert-logo-ucl.html" 
    seal: false
    yolo: no
    lib_dir: libs
    nature:
      beforeInit: ["https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: yes
      highlightSpans: true
      countIncrementalSlides: no
      ratio: '16:9'
      titleSlideClass:
      - center
      - middle
    self_contained: false 
    css:
    - "../assets/beamer.css"
---

```{r echo=F,message=FALSE,warning=FALSE,comment=NA}
# Sources the R file with all the relevant setup and commands
source("../assets/setup.R")

# Stuff from 'xaringanExtra' (https://pkg.garrickadenbuie.com/xaringanExtra)
# This allows the use of panels (from 'xaringanExtra')
xaringanExtra::use_panelset()
# This allows to copy code from the slides directly
xaringanExtra::use_clipboard()
# This freezes the frame for when there's a gif included
xaringanExtra::use_freezeframe()

# Defines the path to the file with the .bib entries (in case there are references)
bibfile=ReadBib("~/Dropbox/Perso/Office/CV/mypubs.bib",check = FALSE)

```

```{r title-page, child="../assets/title-slide-gb.Rmd"}
```

# Summary

- Expected Value of Sample Information

- Expected Net Benefit of Sampling

   - Trial costs

   - Challenges/Discussion

`r vspace("4em")`

.content-box-beamer[
### **References** 

`r vspace("20px")`

`r bmhe(5.4)`

`r esdm(12)`

`r bcea_book(4.3)` 

]

---

# Research priority 

## Expected value of **sample** information

`r vspace("-15px")`

`r include_fig("voi_scheme1.png",width="65%")`

---

count: false

# Research priority

## Expected value of **sample** information

`r vspace("-15px")`

`r include_fig("voi_scheme2.png",width="65%")`

---

# Optimal study design

The optimal design of a study to make more informed decisions depends on 2 main components

`r vspace("30px")`

--

1. **Cost of the study**
   
   Cost $\class{blue}{=}$ .blue[Fixed] $\class{blue}{+}$ .red[Intervention] $\class{blue}{+}$ .red[Opportunity]

   - .blue[Fixed costs] =  Staff time: managers, coordinator, administrator, statistician, data-base support, etc...

   - .red[These] depend on the sample size and study design

`r vspace("40px")`

--

<ol style="counter-reset: my-counter 1;">
    <li><b>Population EVSI</b></li>
</ol>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Population EVSI $=$ EVSI \\(\times\\) prevalence \\(\times\\) time horizon
   
`r vspace("40px")`

--

**NB:** Whether or not the study is worth it depends on its .olive[**Expected Net Benefit of Sampling**] (ENBS)
`r vspace("10px")`

$$`r sftext("ENBS")` = `r sftext("Population EVSI")` - `r sftext("Cost of the study")`$$

- Only studies where expected benefits outweigh study costs are a good use of resources
- Choose the design with greatest ENBS:
   - No value of a study design with ENBS < 0
   - There is value in a study where ENBS > 0... even if it not the maximum ENBS

---

count: false 
exclude: true
# Research priority 

## Expected value of **sample** information

`r vspace("-35px")`

.pull-left[
`r include_fig("voi1.png",width="85%")`
]
.pull-right[
`r include_fig("voi2.png",width="85%")`
]

`r vspace("-25px")`

.small[
`r icon::fontawesome("github")` [https://github.com/giabaio/EVSI](https://github.com/giabaio/EVSI) and [https://github.com/chjackson/voi](https://github.com/chjackson/voi)    
`r icon::fontawesome("laptop")` [https://egon.stats.ucl.ac.uk/projects/EVSI](https://egon.stats.ucl.ac.uk/projects/EVSI)

`r vspace("10px")`

`r icon::academicons$doi`  [Heath et al (2019)](https://doi.org/10.1177/0272989X19837983)     
]

---

count: false 
exclude: true
# Research priority

## Expected value of **sample** information

`r include_fig("voi3.png",width="63%")`

---

# Example: Attendance at breast cancer screening

### Setup
`r vspace("-20px")`

Based on [Richards et al 2001](journals.sagepub.com/doi/pdf/10.1136/jms.8.2.91)

-  Cluster randomised 2×2 factorial trial
- 24 practices randomised
- None, Flag, Letter, Both

--
   
EVSI analysis performed

-  BEFORE: Based on evidence base before the trial
   
   - Monte Carlo (MC) simulation

- AFTER: Based on pre-trial evidence base updated by the trial

   - Markov Chain Monte Carlo (MCMC) simulation

--

### Inputs
`r vspace("-20px")`

- Decision tree model

- Evidence on efficacy before Richards et al based on systematic review of similar types of intervention

- Other model inputs from routine data sources (Toms 2004) and cohort study (Wolstenholme 1998)

- Prevalence: 300,000 per year eligible for 1st invitation to screening
   - 30,000 in low-uptake practices as sensitivity analysis

- Time horizon = 10 years, 3.5% discount rate

- Willingness to pay per QALY = £20,000

---

count: false 
# Example: Attendance at breast cancer screening 

```{r echo=FALSE,fig.width=13,fig.height=8,opts=list(width="75%",title="INSERT TEXT HERE")}
richards=readxl::read_xlsx("img/richards.xlsx",sheet="before") %>% as_tibble()
richards %>% ggplot(aes(x,y,color=group))+geom_line()+theme_bw()+
  xlab("Number of practices per arm")+ylab("")+
  labs(title="Before Richards trial (willingness to pay = £20 000",color="")+geom_point()+
  scale_color_manual(
    values=c("Cost"="red","ENBS"="black","popEVSI"="blue"),
    labels=c("Total trial costs","ENBS","Population EVSI"))+
    scale_y_continuous(labels=scales::dollar_format(prefix="£")) +
    geom_hline(yintercept = 0,linetype="dashed")
```

---

count: false 
# Example: Attendance at breast cancer screening 

```{r echo=FALSE,fig.width=13,fig.height=8,opts=list(width="75%",title="INSERT TEXT HERE")}
richards=readxl::read_xlsx("img/richards.xlsx",sheet="before-after") %>% as_tibble()
richards %>% ggplot(aes(x,y,color=Time))+geom_line()+theme_bw()+
  xlab("Number of practices per arm")+ylab("ENBS")+
  labs(title="ENBS - before and after the Richards study (willingness to pay = £20 000",color="")+geom_point()+
  scale_y_continuous(labels=scales::dollar_format(prefix="£")) +
  geom_hline(yintercept = 0,linetype="dashed")
```

---

count: false 
# Example: Attendance at breast cancer screening 

```{r echo=FALSE,fig.width=13,fig.height=8,opts=list(width="75%",title="INSERT TEXT HERE")}
richards=readxl::read_xlsx("img/richards.xlsx",sheet="groups") %>% as_tibble()
richards %>% ggplot(aes(x,y,color=group))+geom_line()+theme_bw()+
  xlab("Number of practices per arm")+ylab("ENBS")+
  labs(title="ENBS - decision population (willingness to pay = £20 000",color="")+geom_point()+
  scale_y_continuous(labels=scales::dollar_format(prefix="£")) +
  geom_hline(yintercept = 0,linetype="dashed")
```

---

# Implications for the research design

`r vspace("30px")`

- There was value in carrying out the Richards trial based on prior evidence

   - Sample size could have been larger
   
`r vspace("30px")`

--
   
- No further value in running a new trial subsequent to the Richards et al trial

`r vspace("30px")`

- Only considered new study measuring relative intervention effects

   - ... and only one aspect of study design (sample size)
   
   - Richards et al also collected intervention cost data

---

# Research priority

```{css echo=FALSE}
/* Some ad-hoc text boxes */
.box-left {
    position: fixed;
    /* if I leave the top spacing then Chrome cuts out the bottom-left part of the footer
    top: 96.6%;
    */
    bottom: 52.8%;
    left: 43%;
    text-align: left;
    width: 12%;
    font-size: 60%;
    text-align: center;
    color: blue;
}

.box-right {
    position: fixed;
    /* if I leave the top spacing then Chrome cuts out the bottom-left part of the footer
    top: 96.6%;
    */
    bottom: 53.0%;
    left: 60%;
    text-align: left;
    width: 12%;
    font-size: 60%;
    text-align: center;
    color: magenta;
}

.arrow1 {
  position: fixed;
  top: 20.0%;
  left: 25%;
  width: 12%;
  text-align: center;
  color: black;
}

.arrow2 {
  position: fixed;
  top: 20.0%;
  left: 60%;
  width: 12%;
  text-align: center;
  color: black;
}
```

## Expected value of **sample** information .alignright[.small[`r icon::academicons$doi` [Jackson et al (2021)](https://www.annualreviews.org/doi/pdf/10.1146/annurev-statistics-040120-010730)]]

-  EVSI measures the value of reducing uncertainty by running a study of **a given design**

$$\evsi = \E_{\boldsymbol{X}} \left[ \max_t\ \color{blue}{\E_{\boldsymbol\theta \mid \boldsymbol{X}} \left[ \nb_t(\boldsymbol\theta) \right]} \right] - \max_{t}\color{magenta}{\E_{\boldsymbol\theta}\left[\nb_{t}(\boldsymbol\theta)\right]}$$

.box-left[
↑    
Value of decision based on **sample** information (for a given study design) 
]
.box-right[
↑    
Value of decision based on **current** information
]

`r vspace("70px")`

-  Can compare the benefits and costs of a study with given design

   - To see if a proposed study likely to be a good use of resources
   - To find the optimal study design

---

count: false
# Research priority

## Expected value of **sample** information .alignright[.small[`r icon::academicons$doi` [Jackson et al (2021)](https://www.annualreviews.org/doi/pdf/10.1146/annurev-statistics-040120-010730)]]

-  EVSI measures the value of reducing uncertainty by running a study of **a given design**

$$\evsi = \E_{\boldsymbol{X}} \left[ \max_t\ \color{blue}{\E_{\boldsymbol\theta \mid \boldsymbol{X}} \left[ \nb_t(\boldsymbol\theta) \right]} \right] - \max_{t}\color{magenta}{\E_{\boldsymbol\theta}\left[\nb_{t}(\boldsymbol\theta)\right]}$$

.box-left[
↑    
Value of decision based on **sample** information (for a given study design)
]
.box-right[
↑    
Value of decision based on **current** information
]

`r vspace("70px")`

-  Can compare the benefits and costs of a study with given design

   - To see if a proposed study likely to be a good use of resources
   - To find the optimal study design

- Computationally complex
    - Requires specific knowledge of the model for (future/hypothetical) data collection

- Again, recent methods have improved efficiency .alignright[.small[`r icon::academicons$doi` [Heath et al (2021)](https://doi.org/10.1177/0272989X20912402)]]
   - Regression-based .small[(`r icon::academicons$pubmed` [Strong et al, 2015](https://pubmed.ncbi.nlm.nih.gov/25810269/))]
   - Importance Sampling .small[(`r icon::academicons$pubmed` [Menzies et al, 2016](https://pubmed.ncbi.nlm.nih.gov/25911600/))]
   - Gaussian approximation .small[(`r icon::academicons$pubmed` [Jalal et al, 2015](https://pubmed.ncbi.nlm.nih.gov/25840900/); `r icon::academicons$pubmed` [Jalal and Alarid-Escudero, 2018](https://pubmed.ncbi.nlm.nih.gov/28735563/))]
   - Moment matching .small[(`r icon::academicons$pubmed` [Heath et al, 2018](https://pubmed.ncbi.nlm.nih.gov/29126364/))]

- Can be used to drive design of new study (eg sample size calculations)

---

# Required inputs and expertise to compute EVSI

## Inputs
`r vspace("-50px")`
```{r echo=FALSE}
tab=tibble(
  requirements=c(
    "Decision-Analytic Model",
    "Probabilistic sensitivity analysis",
    "Simulations of the expected net benefit conditional on \\(\\bm\\phi\\) (required to compute EVPPI)"
  ),
  rb=c(
    "",
    "\\(\\times\\)",
    ""
  ),
  is=c(
    "",
    "\\(\\times\\)",
    "\\(\\times\\)"
  ),
  ga=c(
    "",
    "\\(\\times\\)",
    ""
  ),
  mm=c(
    "\\(\\times\\)",
    "\\(\\times\\)",
    "\\(\\times\\)"
  )
)
tab %>% kable(col.names=c("Requirements","RB","IS","GA","MM")) %>% 
  kableExtra::column_spec(1,width="30em") %>% 
  kableExtra::column_spec(2:5,width="2em") %>% 
  kableExtra::add_header_above(c(" "=1,"Methods"=4)) %>% 
  row_spec(0,extra_css="border-bottom: 1px solid; border-bottom-color: black;") %>% 
  row_spec(nrow(tab),extra_css="border-bottom: 1px solid; border-bottom-color: black;")
```

`r vspace("50px")`

## Expertise & skills
`r vspace("-40px")`
```{r echo=FALSE}
tab=tibble(
  requirements=c(
    "Regression methods",
    "Specification of likelihoods",
    "Requirement of summary statistics",
    "Bayesian updating"
  ),
  rb=c(
    "\\(\\times\\)",
    "",
    "\\(\\times\\)",
    ""
  ),
  is=c(
    "",
    "\\(\\times\\)",
    "",
    ""
  ),
  ga=c(
    "\\(\\times\\)",
    "",
    "*",
    "*"
  ),
  mm=c(
    "",
    "",
    "",
    "\\(\\times\\)"
  )
)
tab %>% kable(col.names=c("Requirements","RB","IS","GA","MM")) %>% 
  kable_styling(full_width = T) %>% 
  kableExtra::column_spec(1,width="30em") %>% 
  kableExtra::column_spec(2:5,width="2em") %>% 
  kableExtra::add_header_above(c(" "=1,"Methods"=4)) %>% 
  row_spec(0,extra_css="border-bottom: 1px solid; border-bottom-color: black;") %>% 
  row_spec(nrow(tab),extra_css="border-bottom: 1px solid; border-bottom-color: black;")
```

---

# Strengths and limitations of each method

```{r echo=FALSE}
tab=tibble(
  requirements=c(
    "Can estimate the EVSI with a large number of parameters",
    "Inaccurate with small sample sizes",
    "Computational challenge with large proposed studies",
    "Requires a low dimensional summary statistics",
    "Requires accurate EVPPI estimation",
    "Uses non-parametric regression",
    "Quantifies uncertainty in EVSI estimation",
    "Estimates EVSI across sample size"
  ),
  rb=c(
    "",
    "",
    "",
    "\\(\\times\\)",
    "",
    "\\(\\times\\)",
    "\\(\\times\\)",
    ""
  ),
  is=c(
    "\\(\\times\\)",
    "",
    "\\(\\times\\)",
    "",
    "\\(\\times\\)",
    "",
    "",
    ""
  ),
  ga=c(
    "",
    "\\(\\times\\)",
    "",
    "",
    "",
    "\\(\\times\\)",
    "\\(\\times\\)",
    "\\(\\times\\)"
  ),
  mm=c(
    "\\(\\times\\)",
    "\\(\\times\\)",
    "",
    "",
    "\\(\\times\\)",
    "",
    "\\(\\times\\)",
    "\\(\\times\\)"
  )
)
tab %>% kable(col.names=c("Requirements","RB","IS","GA","MM")) %>% 
  kable_styling(full_width = T) %>% 
  kableExtra::column_spec(1,width="30em") %>% 
  kableExtra::column_spec(2:5,width="2em") %>% 
  kableExtra::add_header_above(c(" "=1,"Methods"=4)) %>% 
  row_spec(0,extra_css="border-bottom: 1px solid; border-bottom-color: black;") %>% 
  row_spec(nrow(tab),extra_css="border-bottom: 1px solid; border-bottom-color: black;")
```

---

# *"Tell me a sad story in just one slide..."*

`r vspace("-10px")`

### [NICE HTA evaluation methods update](https://www.nice.org.uk/about/what-we-do/our-programmes/nice-guidance/nice-technology-appraisal-guidance/changes-to-health-technology-evaluation) (2021) .alignright[.small[`r icon::fontawesome("arrow-circle-right")` [Next lecture](../14_Data_EVSI/index.html)]]
.medium[
> *2.16. The use of Expected Value of Perfect Information (EVPI) will .red[**not**] be adopted into the NICE methods. Stakeholders raised concerns about this proposal and the majority disagreed with it. It was noted that the added value of EVPI and how it would be used in decision-making was unclear as experiences from other countries suggested that its added value to decision making is minimal. There were concerns that it would add complexity to decision making, and the additional burden for analysts and reviewers may not be worth it. On the other hand, .blue[some stakeholders argued that the proposal did not go far enough and should include expected value of partially perfect information (EVPPI) and expected value of sample information (EVSI)].* 
]

---

# *"Tell me a sad story in just one slide..."*

`r vspace("-10px")`

### [NICE HTA evaluation methods update](https://www.nice.org.uk/about/what-we-do/our-programmes/nice-guidance/nice-technology-appraisal-guidance/changes-to-health-technology-evaluation) (2021) .alignright[.small[`r icon::fontawesome("arrow-circle-right")` [Next lecture](../14_Data_EVSI/index.html)]]
.medium[
> *2.16. The use of Expected Value of Perfect Information (EVPI) will .red[**not**] be adopted into the NICE methods. Stakeholders raised concerns about this proposal and the majority disagreed with it. It was noted that the added value of EVPI and how it would be used in decision-making was unclear as experiences from other countries suggested that its added value to decision making is minimal. There were concerns that it would add complexity to decision making, and the additional burden for analysts and reviewers may not be worth it. On the other hand, .blue[some stakeholders argued that the proposal did not go far enough and should include expected value of partially perfect information (EVPPI) and expected value of sample information (EVSI)].* 
]

`r vspace("30px")`

.pull-left[

<center><img width="580!important;" src="img/careless-whisper.gif" title=""></center>

]

.pull-right[
`r vspace("-40px")`

.medium[
- Push from industrial representatives, despite attempts at clarifying/simplyfing concepts/guidelines

- CADHT actually say

> *When the decision problem includes consideration of further research to inform future decisions, .blue[a value-of-information analysis should be undertaken as part of the reference case]. [...] To identify these critical values and correctly quantify the impact of a parameter taking a specific value (on both the probability of an intervention being cost-effective and the expected net benefit), .blue[recent methodological work suggests that a two-stage expected value of perfect parameter information analysis may be useful]*

]
]
